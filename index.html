<head>
    <link rel="shortcut icon" href="/favicon.ico" />
    <style>
    body {
        margin:    5 auto;
        padding: 10px;
        max-width: 900px;
    }

    img {
      position: absolute;
      transform: translateY(-50%);
      top: 50%;
      max-width: 100%;
      max-height: 100%;
      background: #fff;
    }
  #title-wrapper {
    margin: 5px 0px;
  }
  #title-wrapper > input {
    padding-left: 5px;
    padding-top: 5px;
    width: calc(100% - 222px);
  }
  #title-wrapper > label {
    padding-right: 5px;
    padding-top: 5px;
    width: 200px;
  }
  #info {
    position: relative;
    height: 400px;
  }
  #input {
    background: #ccc;
    position: absolute;
    border: 3px solid black;
    border-radius: 3px;
    width: calc(50% - 20px);
    height: 400px;
    left: 0;
    top: 0;
  }
  #output
  {
    background: #ccc;
    position: absolute;
    border: 3px solid black;
    border-radius: 3px;
    display: inline-block;
    width: calc(50% - 20px);
    height: 400px;
    left: calc(50% + 20px);
    top: 0;
  }
  #info h4 {position: absolute; top: -45px; }
  #download {
    font-size: 40px;
    font-weight: bold;
    padding: 40px;
    border-radius: 5px;
    border: 1px solid green;
    background: lightgreen;
    margin-top: 20px;
    width: 100%;
    text-align: center;
  }

  #progress {
    background: lightgreen;
    padding: 10px;
    font-size: 20px;
    position: absolute;
    top: 50%;
    left: 10px;
    width: calc(100% - 40px);
    text-align: center;
  }

  #error {
    color: red;
    font-weight: 16px;
    width: 100%;
    padding: 10px;
    margin: 10px;
  }

    </style>
</head>
<h1>SVG Autocrop</h1>
<div id="title-wrapper"><label> Step 1: Optionally choose a title</label><input id="title"></input></div>
<div><span> Step 2: Drag and Drop file below or </span><input type="file" accept="image/svg+xml" id="upload"></input><br/>
<br/>
<div id="info">
  <div id="input"><h4>Original file</h4><img /></div>
  <div id="output"><h4>After autocrop</h4><img /><div id="progress">Work in progress. Please wait ...</div></div>
</div>
<input id="download" type="button" value="Download"></input>
<div id="error"></div>
<script>

  const upload = document.querySelector("#upload");
  const input = document.querySelector("#input");
  const inputImg = document.querySelector('#input img');
  const output = document.querySelector("#output");
  const outputImg = document.querySelector('#output img');
  const download = document.querySelector('#download');
  const progress = document.querySelector('#progress');
  const error = document.querySelector('#error');

  function read() {
    var fileToLoad = upload.files[0];
    var fileReader = new FileReader();
    fileReader.onload = function(fileLoadedEvent){
      var textFromFileLoaded = fileLoadedEvent.target.result;
      showOriginal(textFromFileLoaded);
      const isLocalhost= window.location.hostname === 'localhost';
      fetch(isLocalhost ? '/' : '/autocrop', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          svg: textFromFileLoaded
        })
      }).then(function(response) {
        return response.json();
      }).then(function(result) {
        showResult(result);
      });
    };
    fileReader.readAsText(fileToLoad, "UTF-8");
  }

  function showOriginal(svg) {
    try {
      inputImg.src = "data:image/svg+xml;base64," + btoa(svg);
    } catch(ex) {
      inputImg.src = 'bad';
    }
  }

  function showResult(result) {
    if (result.error) {
      download.style.display = 'none';
      progress.style.display = 'none';
      outputImg.src = '';
      error.style.display = '';
      error.innerText = result.error;
    } else {
      outputImg.src = "data:image/svg+xml;base64," + btoa(result.result);
      output.src = result.result;
      download.style.display = '';
      progress.style.display = 'none';
      error.style.display = 'none';
    }
  }

  function uploadChanged() {
    read();
    outputImg.src = '';
    download.style.display = 'none';
    progress.style.display = '';
    error.style.display = 'none';
  }

  upload.addEventListener('change', function() {
    uploadChanged();
  }, false);

  download.addEventListener('click', function() {
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = outputImg.src;
    a.download = upload.files[0].name;
    document.body.appendChild(a);
    a.click();
  }, false);

  download.style.display = 'none';
  progress.style.display = 'none';
  error.style.display = 'none';

  // DRAG AND DROP

  let dropArea = document.querySelector('#input');
  let highlightZone = dropArea;

  dropArea.addEventListener('dragenter', handlerFunction, false);
  dropArea.addEventListener('dragleave', handlerFunction, false);
  dropArea.addEventListener('dragover', handlerFunction, false);
  dropArea.addEventListener('drop', handlerFunction, false);

  dropArea.addEventListener('dragenter', function() { highlightZone.style.border = "3px solid green" }, false);
  dropArea.addEventListener('dragover', function() { highlightZone.style.border = "3px solid green" }, false);
  dropArea.addEventListener('drop', function() { highlightZone.style.border = "3px solid black" }, false);
  dropArea.addEventListener('dragleave', function() { highlightZone.style.border = "3px solid black" }, false);

  function handlerFunction(e) {
    e.preventDefault()
    e.stopPropagation()
    let dt = e.dataTransfer;
    let files = dt.files;
    const file = files[0];
    if (file) {
      upload.files = dt.files;
      uploadChanged();
    }
  }


</script>
